<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Vinicius Vieira</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: var(--glass-border);
        }

        .section-card {
            background: var(--card-bg);
            border: var(--glass-border);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
        }

        .project-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .delete-btn {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            padding: 8px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: rgba(255, 68, 68, 0.3);
        }
    </style>
</head>

<body>

    <div class="container" style="padding-top: 50px;">
        <div class="admin-header">
            <h1>Painel de Controle</h1>
            <div style="display: flex; gap: 15px;">
                <a href="index.html" class="btn btn-outline" target="_blank">Ver Site</a>
                <button id="logout-btn" class="btn btn-outline"
                    style="border-color: #ff4444; color: #ff4444;">Sair</button>
            </div>
        </div>

        <!-- Brand Name -->
        <div class="section-card">
            <h2>Nome da Marca (Logo)</h2>
            <p style="font-size: 0.8rem; color: #aaa; margin-bottom: 20px;">Use &lt;span
                class="gradient-text"&gt;Texto&lt;/span&gt; para o efeito colorido.</p>
            <div class="input-group">
                <input type="text" id="brand-input" class="input-field"
                    placeholder='Vinicius<span class="gradient-text">Vieira</span>'>
            </div>
            <button id="save-brand-btn" class="btn btn-primary">Salvar Nome</button>
        </div>

        <!-- Change Password -->
        <div class="section-card">
            <h2>Segurança</h2>
            <div class="input-group" style="margin-top: 20px;">
                <label>Nova Senha</label>
                <input type="password" id="new-password" class="input-field">
            </div>
            <button id="change-pass-btn" class="btn btn-primary">Atualizar Senha</button>
        </div>

        <!-- Edit Hero -->
        <div class="section-card">
            <h2>Editar Hero Section</h2>
            <div class="input-group" style="margin-top: 20px;">
                <label>Foto de Perfil (JPG, PNG ou SVG)</label>
                <input type="file" id="hero-photo-file" class="input-field" accept=".jpg, .jpeg, .png, .svg, image/*">
                <input type="hidden" id="hero-photo-url"> <!-- Hidden field to store current/new URL -->
                <p id="current-hero-photo-status" style="font-size: 0.8rem; color: #aaa; margin-top: 5px;">Nenhuma foto
                    nova selecionada.</p>
            </div>
            <div class="input-group">
                <label>Título Principal</label>
                <input type="text" id="hero-title-input" class="input-field">
            </div>
            <div class="input-group">
                <label>Subtítulo</label>
                <textarea id="hero-subtitle-input" class="input-field" rows="3"></textarea>
            </div>
            <button id="save-hero-btn" class="btn btn-primary">Salvar Alterações</button>
        </div>

        <!-- Site Texts Editor -->
        <div class="section-card">
            <h2>Editor de Textos do Site</h2>
            <div class="input-group">
                <label>Título Seção Sobre</label>
                <input type="text" id="text-about-title" class="input-field" placeholder="Sobre Mim">
            </div>
            <div class="input-group">
                <label>Texto Sobre</label>
                <textarea id="text-about-desc" class="input-field" rows="5"></textarea>
            </div>
            <div class="input-group">
                <label>Título Seção Projetos</label>
                <input type="text" id="text-projects-title" class="input-field" placeholder="Projetos Recentes">
            </div>
            <div class="input-group">
                <label>Título Seção Contato</label>
                <input type="text" id="text-contact-title" class="input-field" placeholder="Entre em Contato">
            </div>

            <div class="input-group"
                style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <label style="color: var(--accent-primary);">Lista de Habilidades (Separadas por vírgula)</label>
                <textarea id="text-skills" class="input-field" rows="3"
                    placeholder="HTML5, CSS3, JavaScript, React..."></textarea>
                <p style="font-size: 0.8rem; color: #aaa;">Essas tags aparecerão na seção "Sobre Mim".</p>
            </div>

            <button id="save-texts-btn" class="btn btn-primary">Salvar Textos</button>
        </div>

        <!-- Add/Edit Project -->
        <div class="section-card">
            <h2 id="project-form-title">Adicionar Novo Projeto</h2>
            <form id="add-project-form">
                <input type="hidden" id="editing-project-id">

                <div class="input-group">
                    <label>Título do Projeto</label>
                    <input type="text" id="proj-title" class="input-field" required>
                </div>
                <div class="input-group">
                    <label>Descrição</label>
                    <textarea id="proj-desc" class="input-field" rows="3" required></textarea>
                </div>
                <div class="input-group">
                    <label>Tecnologias</label>
                    <input type="text" id="proj-specs" class="input-field" placeholder="React, Node, etc...">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="input-group">
                        <label>Link do Projeto</label>
                        <input type="text" id="proj-link" class="input-field">
                    </div>
                    <div class="input-group">
                        <label>Link do Figma</label>
                        <input type="text" id="proj-figma" class="input-field">
                    </div>
                </div>

                <div class="input-group" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                    <label style="color: var(--accent-primary);">Imagem de Capa (JPG, PNG, SVG)</label>
                    <!-- Current Cover Container -->
                    <div id="current-cover-container" style="display: none; margin-bottom: 10px;">
                        <p style="font-size: 0.8rem; color: #aaa; margin-bottom: 5px;">Imagem Atual:</p>
                        <img id="current-cover-img" src=""
                            style="width: 100px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #555;">
                        <p style="font-size: 0.7rem; color: #888;">Para trocar, selecione um novo arquivo abaixo.</p>
                    </div>
                    <input type="file" id="proj-img-file" class="input-field" accept=".jpg, .jpeg, .png, .svg, image/*">
                </div>

                <div class="input-group" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                    <label style="color: var(--accent-primary);">Galeria do Projeto (JPG, PNG, SVG)</label>
                    <!-- Current Gallery Container -->
                    <div id="current-gallery-container"
                        style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;"></div>

                    <input type="file" id="proj-gallery-files" class="input-field"
                        accept=".jpg, .jpeg, .png, .svg, image/*" multiple>
                    <p style="font-size: 0.8rem; color: #aaa;">Novas imagens serão adicionadas à galeria existente.</p>
                </div>

                <div class="input-group"
                    style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <label style="color: #ea580c;">Galeria do Design/Figma (JPG, PNG, SVG)</label>
                    <!-- Current Figma Container -->
                    <div id="current-figma-container"
                        style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;"></div>

                    <input type="file" id="proj-figma-files" class="input-field"
                        accept=".jpg, .jpeg, .png, .svg, image/*" multiple>
                    <p style="font-size: 0.8rem; color: #aaa;">Novas imagens serão adicionadas à galeria existente.</p>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" id="submit-project-btn">Adicionar Projeto</button>
                    <button type="button" id="cancel-edit-btn" class="btn btn-outline" style="display: none;">Cancelar
                        Edição</button>
                </div>
            </form>
        </div>

        <!-- List Projects -->
        <div class="section-card">
            <h2>Gerenciar Projetos</h2>
            <div id="admin-projects-list">
                <!-- List here -->
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        // Auth Check
        window.Auth.checkAuth();
        document.getElementById('logout-btn').addEventListener('click', window.Auth.logout);

        // Change Password
        document.getElementById('change-pass-btn').addEventListener('click', () => {
            const newPass = document.getElementById('new-password').value;
            if (newPass && newPass.length >= 4) {
                window.Auth.changePassword(newPass);
                alert('Senha alterada com sucesso!');
                document.getElementById('new-password').value = '';
            } else {
                alert('A senha deve ter pelo menos 4 caracteres.');
            }
        });

        // Helper to read file
        const readFileAsBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        // --- GLOBAL TEXTS ---
        const loadTexts = () => {
            const texts = JSON.parse(localStorage.getItem('portfolio_texts')) || {};
            document.getElementById('text-about-title').value = texts.aboutTitle || '';
            document.getElementById('text-about-desc').value = texts.aboutDesc || '';
            document.getElementById('text-projects-title').value = texts.projectsTitle || '';
            document.getElementById('text-contact-title').value = texts.contactTitle || '';
            document.getElementById('text-skills').value = texts.skills || 'HTML5, CSS3, JavaScript, React, Node.js, Git';
        };
        loadTexts();

        document.getElementById('save-texts-btn').addEventListener('click', () => {
            const texts = {
                aboutTitle: document.getElementById('text-about-title').value || 'Sobre Mim',
                aboutDesc: document.getElementById('text-about-desc').value || 'Sou um desenvolvedor apaixonado por criar experiências web modernas e intuitivas.',
                projectsTitle: document.getElementById('text-projects-title').value || 'Meus Projetos',
                contactTitle: document.getElementById('text-contact-title').value || 'Vamos Trabalhar Juntos?',
                skills: document.getElementById('text-skills').value || 'HTML5, CSS3, JavaScript, React, Node.js, Git'
            };
            localStorage.setItem('portfolio_texts', JSON.stringify(texts));
            alert('Textos e Habilidades atualizados!');
        });

        // --- BRAND & HERO ---
        const brandName = localStorage.getItem('portfolio_brand') || 'Vinicius<span class="gradient-text">Vieira</span>';
        document.getElementById('brand-input').value = brandName;

        document.getElementById('save-brand-btn').addEventListener('click', () => {
            const newBrand = document.getElementById('brand-input').value;
            localStorage.setItem('portfolio_brand', newBrand);
            alert('Nome da marca atualizado!');
        });

        const heroData = JSON.parse(localStorage.getItem('portfolio_hero')) || {};
        document.getElementById('hero-title-input').value = heroData.title || '';
        document.getElementById('hero-subtitle-input').value = heroData.subtitle || '';
        document.getElementById('hero-photo-url').value = heroData.photoUrl || '';
        if (heroData.photoUrl) {
            document.getElementById('current-hero-photo-status').innerText = "Foto atual carregada.";
        }

        document.getElementById('save-hero-btn').addEventListener('click', async () => {
            const photoFile = document.getElementById('hero-photo-file').files[0];
            let photoUrl = document.getElementById('hero-photo-url').value;

            if (photoFile) {
                try {
                    photoUrl = await readFileAsBase64(photoFile);
                } catch (e) {
                    alert('Erro ao ler arquivo da foto.');
                    return;
                }
            }

            const newData = {
                title: document.getElementById('hero-title-input').value,
                subtitle: document.getElementById('hero-subtitle-input').value,
                photoUrl: photoUrl
            };
            localStorage.setItem('portfolio_hero', JSON.stringify(newData));
            alert('Hero section atualizado!');
        });

        // --- PROJECTS ---
        function renderAdminProjects() {
            const projects = JSON.parse(localStorage.getItem('portfolio_projects')) || [];
            const listEl = document.getElementById('admin-projects-list');

            listEl.innerHTML = projects.map((p, index) => `
                <div class="project-list-item">
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <img src="${p.image}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                        <div>
                            <strong>${p.title}</strong>
                            <p style="font-size: 0.8rem; color: #aaa;">${p.desc ? p.desc.substring(0, 50) + '...' : ''}</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="delete-btn" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6;" onclick="window.editProject(${index})">
                            <i class="ph ph-pencil"></i>
                        </button>
                        <button class="delete-btn" onclick="window.deleteProject(${index})">
                            <i class="ph ph-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Helper to create delete button for images
        const createImgThumb = (src, containerId) => {
            const div = document.createElement('div');
            div.style.position = 'relative';
            div.style.width = '60px';
            div.style.height = '60px';

            const img = document.createElement('img');
            img.src = src;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '4px';
            img.style.border = '1px solid #555';

            const btn = document.createElement('button');
            btn.innerHTML = '&times;';
            btn.style.position = 'absolute';
            btn.style.top = '-5px';
            btn.style.right = '-5px';
            btn.style.background = '#ff4444';
            btn.style.color = 'white';
            btn.style.border = 'none';
            btn.style.borderRadius = '50%';
            btn.style.width = '18px';
            btn.style.height = '18px';
            btn.style.cursor = 'pointer';
            btn.style.fontSize = '12px';
            btn.style.lineHeight = '1';

            btn.onclick = (e) => {
                e.preventDefault(); // Prevent form submit
                div.remove();
            };

            div.appendChild(img);
            div.appendChild(btn);
            document.getElementById(containerId).appendChild(div);
        };

        // Edit Project Mode
        window.editProject = (index) => {
            const projects = JSON.parse(localStorage.getItem('portfolio_projects')) || [];
            const p = projects[index];
            if (!p) return;

            // Scroll to form
            document.getElementById('project-form-title').scrollIntoView({ behavior: 'smooth' });

            // Set Form Data
            document.getElementById('editing-project-id').value = index;
            document.getElementById('project-form-title').innerText = `Editando: ${p.title}`;
            document.getElementById('submit-project-btn').innerText = "Salvar Alterações";
            document.getElementById('cancel-edit-btn').style.display = 'inline-block';

            document.getElementById('proj-title').value = p.title;
            document.getElementById('proj-desc').value = p.desc;
            document.getElementById('proj-specs').value = p.specs;
            document.getElementById('proj-link').value = p.linkProject || '';
            document.getElementById('proj-figma').value = p.linkFigma || '';

            // Show Current Cover
            const coverContainer = document.getElementById('current-cover-container');
            const coverImg = document.getElementById('current-cover-img');
            if (p.image) {
                coverContainer.style.display = 'block';
                coverImg.src = p.image;
            } else {
                coverContainer.style.display = 'none';
            }

            // Show Current Galleries
            const galleryContainer = document.getElementById('current-gallery-container');
            galleryContainer.innerHTML = '';
            if (p.gallery && p.gallery.length > 0) {
                p.gallery.forEach(src => createImgThumb(src, 'current-gallery-container'));
            }

            const figmaContainer = document.getElementById('current-figma-container');
            figmaContainer.innerHTML = '';
            if (p.galleryFigma && p.galleryFigma.length > 0) {
                p.galleryFigma.forEach(src => createImgThumb(src, 'current-figma-container'));
            }
        };

        // Cancel Edit
        document.getElementById('cancel-edit-btn').addEventListener('click', resetProjectForm);

        function resetProjectForm() {
            document.getElementById('add-project-form').reset();
            document.getElementById('editing-project-id').value = '';
            document.getElementById('project-form-title').innerText = 'Adicionar Novo Projeto';
            document.getElementById('submit-project-btn').innerText = 'Adicionar Projeto';
            document.getElementById('cancel-edit-btn').style.display = 'none';

            // Clear thumbs
            document.getElementById('current-cover-container').style.display = 'none';
            document.getElementById('current-gallery-container').innerHTML = '';
            document.getElementById('current-figma-container').innerHTML = '';
        }

        // Add/update Project
        document.getElementById('add-project-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-project-btn');
            const originalText = btn.innerText;
            btn.innerText = "Processando...";
            btn.disabled = true;

            try {
                const projects = JSON.parse(localStorage.getItem('portfolio_projects')) || [];
                const editIndex = document.getElementById('editing-project-id').value;
                const isEdit = editIndex !== '';

                // Read NEW Cover Image
                const coverFile = document.getElementById('proj-img-file').files[0];
                let coverBase64 = null;
                if (coverFile) {
                    coverBase64 = await readFileAsBase64(coverFile);
                }

                // Read NEW Gallery Images
                const galleryFiles = document.getElementById('proj-gallery-files').files;
                let newGalleryUrls = [];
                if (galleryFiles.length > 0) {
                    for (let i = 0; i < galleryFiles.length; i++) {
                        newGalleryUrls.push(await readFileAsBase64(galleryFiles[i]));
                    }
                }

                // Read NEW Figma Gallery
                const figmaFiles = document.getElementById('proj-figma-files').files;
                let newFigmaUrls = [];
                if (figmaFiles.length > 0) {
                    for (let i = 0; i < figmaFiles.length; i++) {
                        newFigmaUrls.push(await readFileAsBase64(figmaFiles[i]));
                    }
                }

                // Determine Final Images (Merge Old + New)
                let finalImage = coverBase64;
                let finalGallery = newGalleryUrls;
                let finalFigma = newFigmaUrls;

                if (isEdit) {
                    // Start with what is remaining in the DOM (what user didn't delete)

                    // Cover: If user uploaded new, use new. If not, use what is in DOM (old).
                    if (!coverBase64) {
                        const oldCoverImg = document.getElementById('current-cover-img');
                        if (oldCoverImg && document.getElementById('current-cover-container').style.display !== 'none') {
                            finalImage = oldCoverImg.src;
                        }
                    }

                    // Gallery: Get all existing src from DOM + new uploads
                    const existingGallery = [];
                    document.querySelectorAll('#current-gallery-container img').forEach(img => existingGallery.push(img.src));
                    finalGallery = [...existingGallery, ...newGalleryUrls];

                    // Figma: Get all existing src from DOM + new uploads
                    const existingFigma = [];
                    document.querySelectorAll('#current-figma-container img').forEach(img => existingFigma.push(img.src));
                    finalFigma = [...existingFigma, ...newFigmaUrls];
                } else {
                    // New Project
                    if (!finalImage) throw new Error('Escolha uma imagem de capa.');
                }

                const projectData = {
                    title: document.getElementById('proj-title').value,
                    desc: document.getElementById('proj-desc').value,
                    specs: document.getElementById('proj-specs').value,
                    linkProject: document.getElementById('proj-link').value,
                    linkFigma: document.getElementById('proj-figma').value,
                    image: finalImage,
                    gallery: finalGallery,
                    galleryFigma: finalFigma
                };

                if (isEdit) {
                    projectData.id = projects[editIndex].id; // Keep ID
                    projects[editIndex] = projectData;
                    alert('Projeto atualizado!');
                } else {
                    projectData.id = Date.now();
                    projects.push(projectData);
                    alert('Projeto criado!');
                }

                localStorage.setItem('portfolio_projects', JSON.stringify(projects));
                resetProjectForm();
                renderAdminProjects();

            } catch (err) {
                console.error(err);
                alert(err.message || 'Erro ao salvar projeto.');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });

        // Delete Project
        window.deleteProject = (index) => {
            if (confirm('Tem certeza que deseja remover este projeto?')) {
                const projects = JSON.parse(localStorage.getItem('portfolio_projects'));
                projects.splice(index, 1);
                localStorage.setItem('portfolio_projects', JSON.stringify(projects));
                renderAdminProjects();
            }
        };

        renderAdminProjects();
    </script>
</body>

</html>