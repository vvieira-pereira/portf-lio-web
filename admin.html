<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Vinicius Vieira</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: var(--glass-border);
        }

        .section-card {
            background: var(--card-bg);
            border: var(--glass-border);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
        }

        .project-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .delete-btn {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            padding: 8px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: rgba(255, 68, 68, 0.3);
        }
    </style>
</head>

<body>

    <div class="container" style="padding-top: 50px;">
        <div class="admin-header">
            <h1>Painel de Controle</h1>
            <div style="display: flex; gap: 15px;">
                <a href="index.html" class="btn btn-outline" target="_blank">Ver Site</a>
                <button id="logout-btn" class="btn btn-outline"
                    style="border-color: #ff4444; color: #ff4444;">Sair</button>
            </div>
        </div>

        <!-- Brand Name -->
        <div class="section-card">
            <h2>Nome da Marca (Logo)</h2>
            <p style="font-size: 0.8rem; color: #aaa; margin-bottom: 20px;">Use &lt;span
                class="gradient-text"&gt;Texto&lt;/span&gt; para o efeito colorido.</p>
            <div class="input-group">
                <input type="text" id="brand-input" class="input-field"
                    placeholder='Vinicius<span class="gradient-text">Vieira</span>'>
            </div>
            <button id="save-brand-btn" class="btn btn-primary">Salvar Nome</button>
        </div>

        <!-- Change Password -->
        <div class="section-card">
            <h2>Segurança</h2>
            <div class="input-group" style="margin-top: 20px;">
                <label>Nova Senha</label>
                <input type="password" id="new-password" class="input-field">
            </div>
            <button id="change-pass-btn" class="btn btn-primary">Atualizar Senha</button>
        </div>

        <!-- Edit Hero -->
        <div class="section-card">
            <h2>Editar Hero Section</h2>
            <div class="input-group" style="margin-top: 20px;">
                <label>Foto de Perfil (JPG, PNG ou SVG)</label>
                <input type="file" id="hero-photo-file" class="input-field" accept=".jpg, .jpeg, .png, .svg, image/*">
                <input type="hidden" id="hero-photo-url"> <!-- Hidden field to store current/new URL -->
                <p id="current-hero-photo-status" style="font-size: 0.8rem; color: #aaa; margin-top: 5px;">Nenhuma foto
                    nova selecionada.</p>
            </div>
            <div class="input-group">
                <label>Título Principal</label>
                <input type="text" id="hero-title-input" class="input-field">
            </div>
            <div class="input-group">
                <label>Subtítulo</label>
                <textarea id="hero-subtitle-input" class="input-field" rows="3"></textarea>
            </div>
            <button id="save-hero-btn" class="btn btn-primary">Salvar Alterações</button>
        </div>

        <!-- Site Texts Editor -->
        <div class="section-card">
            <h2>Editor de Textos do Site</h2>
            <div class="input-group">
                <label>Título Seção Sobre</label>
                <input type="text" id="text-about-title" class="input-field" placeholder="Sobre Mim">
            </div>
            <div class="input-group">
                <label>Texto Sobre</label>
                <textarea id="text-about-desc" class="input-field" rows="5"></textarea>
            </div>
            <div class="input-group">
                <label>Título Seção Projetos</label>
                <input type="text" id="text-projects-title" class="input-field" placeholder="Projetos Recentes">
            </div>
            <div class="input-group">
                <label>Título Seção Contato</label>
                <input type="text" id="text-contact-title" class="input-field" placeholder="Entre em Contato">
            </div>

            <div class="input-group"
                style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <label style="color: var(--accent-primary);">Lista de Habilidades (Separadas por vírgula)</label>
                <textarea id="text-skills" class="input-field" rows="3"
                    placeholder="HTML5, CSS3, JavaScript, React..."></textarea>
                <p style="font-size: 0.8rem; color: #aaa;">Essas tags aparecerão na seção "Sobre Mim".</p>
            </div>

            <button id="save-texts-btn" class="btn btn-primary">Salvar Textos</button>
        </div>

        <!-- Add/Edit Project -->
        <div class="section-card">
            <h2 id="project-form-title">Adicionar Novo Projeto</h2>
            <form id="add-project-form">
                <input type="hidden" id="editing-project-id">

                <div class="input-group">
                    <label>Título do Projeto</label>
                    <input type="text" id="proj-title" class="input-field" required>
                </div>
                <div class="input-group">
                    <label>Descrição</label>
                    <textarea id="proj-desc" class="input-field" rows="3" required></textarea>
                </div>
                <div class="input-group">
                    <label>Tecnologias</label>
                    <input type="text" id="proj-specs" class="input-field" placeholder="React, Node, etc...">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    <div class="input-group">
                        <label>Link do Projeto</label>
                        <input type="text" id="proj-link" class="input-field">
                    </div>
                    <div class="input-group">
                        <label>Link do GitHub</label>
                        <input type="text" id="proj-github" class="input-field">
                    </div>
                    <div class="input-group">
                        <label>Link do Figma</label>
                        <input type="text" id="proj-figma" class="input-field">
                    </div>
                </div>

                <div class="input-group" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                    <label style="color: var(--accent-primary);">Imagem de Capa (JPG, PNG, SVG)</label>
                    <!-- Current Cover Container -->
                    <div id="current-cover-container" style="display: none; margin-bottom: 10px;">
                        <p style="font-size: 0.8rem; color: #aaa; margin-bottom: 5px;">Imagem Atual:</p>
                        <img id="current-cover-img" src=""
                            style="width: 100px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #555;">
                        <p style="font-size: 0.7rem; color: #888;">Para trocar, selecione um novo arquivo abaixo.</p>
                    </div>
                    <input type="file" id="proj-img-file" class="input-field" accept=".jpg, .jpeg, .png, .svg, image/*">
                </div>

                <div class="input-group" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                    <label style="color: var(--accent-primary);">Galeria do Projeto (JPG, PNG, SVG)</label>
                    <!-- Current Gallery Container -->
                    <div id="current-gallery-container"
                        style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;"></div>

                    <input type="file" id="proj-gallery-files" class="input-field"
                        accept=".jpg, .jpeg, .png, .svg, image/*" multiple>
                    <p style="font-size: 0.8rem; color: #aaa;">Novas imagens serão adicionadas à galeria existente.</p>
                </div>

                <div class="input-group"
                    style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <label style="color: #ea580c;">Galeria do Design/Figma (JPG, PNG, SVG)</label>
                    <!-- Current Figma Container -->
                    <div id="current-figma-container"
                        style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;"></div>

                    <input type="file" id="proj-figma-files" class="input-field"
                        accept=".jpg, .jpeg, .png, .svg, image/*" multiple>
                    <p style="font-size: 0.8rem; color: #aaa;">Novas imagens serão adicionadas à galeria existente.</p>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" id="submit-project-btn">Adicionar Projeto</button>
                    <button type="button" id="cancel-edit-btn" class="btn btn-outline" style="display: none;">Cancelar
                        Edição</button>
                </div>
            </form>
        </div>

        <!-- List Projects -->
        <div class="section-card">
            <h2>Gerenciar Projetos</h2>
            <div id="admin-projects-list">
                <!-- List here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/admin-supabase.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Auth Check
        window.Auth.checkAuth();
        document.getElementById('logout-btn').addEventListener('click', window.Auth.logout);

        // --- GLOBAL TEXTS (Ainda no localStorage por enquanto ou pode mover pro banco depois) ---
        const loadTexts = () => {
            const texts = JSON.parse(localStorage.getItem('portfolio_texts')) || {};
            document.getElementById('text-about-title').value = texts.aboutTitle || '';
            document.getElementById('text-about-desc').value = texts.aboutDesc || '';
            document.getElementById('text-projects-title').value = texts.projectsTitle || '';
            document.getElementById('text-contact-title').value = texts.contactTitle || '';
            document.getElementById('text-skills').value = texts.skills || 'HTML5, CSS3, JavaScript, React, Node.js, Git';
        };
        loadTexts();

        document.getElementById('save-texts-btn').addEventListener('click', () => {
            const texts = {
                aboutTitle: document.getElementById('text-about-title').value,
                aboutDesc: document.getElementById('text-about-desc').value,
                projectsTitle: document.getElementById('text-projects-title').value,
                contactTitle: document.getElementById('text-contact-title').value,
                skills: document.getElementById('text-skills').value
            };
            localStorage.setItem('portfolio_texts', JSON.stringify(texts));
            alert('Textos e Habilidades atualizados!');
        });

        // --- BRAND & HERO ---
        const loadHeroData = () => {
            const hero = JSON.parse(localStorage.getItem('portfolio_hero')) || {};
            document.getElementById('hero-title-input').value = hero.title || 'Seu Nome';
            document.getElementById('hero-subtitle-input').value = hero.subtitle || 'Sua Profissão';
            document.getElementById('hero-photo-url').value = hero.photoUrl || '';

            if (hero.photoUrl) {
                document.getElementById('current-hero-photo-status').innerText = "Foto atual carregada.";
            }
        };
        loadHeroData();

        const brandName = localStorage.getItem('portfolio_brand') || 'Vinicius<span class="gradient-text">Vieira</span>';
        document.getElementById('brand-input').value = brandName;

        document.getElementById('save-brand-btn').addEventListener('click', () => {
            localStorage.setItem('portfolio_brand', document.getElementById('brand-input').value);
            alert('Nome da marca atualizado!');
        });

        // SALVAR HERO (Aqui corrigimos o seu botão!)
        document.getElementById('save-hero-btn').addEventListener('click', async () => {
            const btn = document.getElementById('save-hero-btn');
            const photoFile = document.getElementById('hero-photo-file').files[0];
            let photoUrl = document.getElementById('hero-photo-url').value;

            btn.disabled = true;
            btn.innerText = "Salvando...";

            try {
                if (photoFile) {
                    console.log("Fazendo upload da foto de perfil...");
                    photoUrl = await window.uploadFile(photoFile, 'profile');
                }

                const heroData = {
                    title: document.getElementById('hero-title-input').value,
                    subtitle: document.getElementById('hero-subtitle-input').value,
                    photoUrl: photoUrl
                };

                localStorage.setItem('portfolio_hero', JSON.stringify(heroData));
                document.getElementById('hero-photo-url').value = photoUrl;
                alert('Hero Section atualizado com sucesso!');
            } catch (error) {
                console.error("Erro no Hero:", error);
                alert("Erro ao salvar Hero: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "Salvar Alterações";
            }
        });

        // --- PROJECTS LOGIC ---

        // Helper para criar miniaturas no formulário
        const createImgThumb = (src, containerId) => {
            const div = document.createElement('div');
            div.className = 'thumb-wrapper';
            div.style = 'position: relative; width: 60px; height: 60px;';
            div.innerHTML = `
                <img src="${src}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px; border: 1px solid #555;">
                <button type="button" onclick="this.parentElement.remove()" style="position: absolute; top: -5px; right: -5px; background: #ff4444; color: white; border: none; border-radius: 50%; width: 18px; height: 18px; cursor: pointer; font-size: 12px;">&times;</button>
            `;
            document.getElementById(containerId).appendChild(div);
        };

        // Editar Projeto
        window.editProject = (index) => {
            const p = window.adminProjects[index];
            if (!p) return;

            document.getElementById('project-form-title').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('editing-project-id').value = p.id;
            document.getElementById('project-form-title').innerText = `Editando: ${p.title}`;
            document.getElementById('submit-project-btn').innerText = "Salvar Alterações";
            document.getElementById('cancel-edit-btn').style.display = 'inline-block';

            document.getElementById('proj-title').value = p.title;
            document.getElementById('proj-desc').value = p.description;
            document.getElementById('proj-specs').value = p.specs;
            document.getElementById('proj-link').value = p.link_project || '';
            document.getElementById('proj-github').value = p.link_github || '';
            document.getElementById('proj-figma').value = p.link_figma || '';

            // Capa Atual
            const coverContainer = document.getElementById('current-cover-container');
            if (p.image_url) {
                coverContainer.style.display = 'block';
                document.getElementById('current-cover-img').src = p.image_url;
            }

            // Galerias Atuais
            const galleryCont = document.getElementById('current-gallery-container');
            galleryCont.innerHTML = '';
            if (p.gallery) p.gallery.forEach(url => createImgThumb(url, 'current-gallery-container'));

            const figmaCont = document.getElementById('current-figma-container');
            figmaCont.innerHTML = '';
            if (p.gallery_figma) p.gallery_figma.forEach(url => createImgThumb(url, 'current-figma-container'));
        };

        const resetProjectForm = () => {
            document.getElementById('add-project-form').reset();
            document.getElementById('editing-project-id').value = '';
            document.getElementById('project-form-title').innerText = 'Adicionar Novo Projeto';
            document.getElementById('submit-project-btn').innerText = 'Adicionar Projeto';
            document.getElementById('cancel-edit-btn').style.display = 'none';
            document.getElementById('current-cover-container').style.display = 'none';
            document.getElementById('current-gallery-container').innerHTML = '';
            document.getElementById('current-figma-container').innerHTML = '';
        };

        document.getElementById('cancel-edit-btn').addEventListener('click', resetProjectForm);

        // Submit Form (Novo ou Edit)
        document.getElementById('add-project-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-project-btn');
            btn.disabled = true;
            btn.innerText = "Enviando...";

            try {
                const id = document.getElementById('editing-project-id').value;
                const isEdit = id !== '';

                // 1. Upload da Capa
                const coverFile = document.getElementById('proj-img-file').files[0];
                let imageUrl = isEdit ? document.getElementById('current-cover-img').src : null;

                if (coverFile) {
                    imageUrl = await window.uploadFile(coverFile, 'covers');
                }

                if (!imageUrl) throw new Error("A imagem de capa é obrigatória.");

                // 2. Galerias
                const galleryFiles = document.getElementById('proj-gallery-files').files;
                const newGalleryUrls = [];
                for (let file of galleryFiles) {
                    const url = await window.uploadFile(file, 'gallery');
                    if (url) newGalleryUrls.push(url);
                }
                const existingGallery = Array.from(document.querySelectorAll('#current-gallery-container img')).map(img => img.src);
                const finalGallery = [...existingGallery, ...newGalleryUrls];

                const figmaFiles = document.getElementById('proj-figma-files').files;
                const newFigmaUrls = [];
                for (let file of figmaFiles) {
                    const url = await window.uploadFile(file, 'figma');
                    if (url) newFigmaUrls.push(url);
                }
                const existingFigma = Array.from(document.querySelectorAll('#current-figma-container img')).map(img => img.src);
                const finalFigma = [...existingFigma, ...newFigmaUrls];

                // 3. Montar Objeto
                const projectData = {
                    title: document.getElementById('proj-title').value,
                    description: document.getElementById('proj-desc').value,
                    specs: document.getElementById('proj-specs').value,
                    link_project: document.getElementById('proj-link').value,
                    link_github: document.getElementById('proj-github').value,
                    link_figma: document.getElementById('proj-figma').value,
                    image_url: imageUrl,
                    gallery: finalGallery,
                    gallery_figma: finalFigma
                };

                // 4. Salvar no Supabase com Verificação
                console.log("Tentando salvar no banco:", projectData);

                let error;
                if (isEdit) {
                    const res = await window.supabaseClient.from('projects').update(projectData).eq('id', id);
                    error = res.error;
                } else {
                    const res = await window.supabaseClient.from('projects').insert([projectData]);
                    error = res.error;
                }

                if (error) {
                    console.error("Erro do Supabase:", error);
                    throw new Error("Erro do Banco: " + error.message);
                }

                alert(isEdit ? 'Projeto atualizado!' : 'Projeto criado!');
                resetProjectForm();
                window.renderAdminProjects();

            } catch (err) {
                console.error("Catched Error:", err);
                alert('Erro: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = (document.getElementById('editing-project-id').value !== '') ? "Salvar Alterações" : "Adicionar Projeto";
            }
        });

        // Inicializar lista
        window.renderAdminProjects();
    </script>
</body>

</html>